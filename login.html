<!DOCTYPE html>
<title>DVO Template</title>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <link rel="stylesheet" href="css/trumbowyg.min.css">
    <script src="https://melvincarvalho.github.io/helloworld/scripts/solid-auth-client.bundle.js"></script>
    <script src="js/vendor/jquery.js"></script>
    <script>
        $(document).ready(function() {

            let laserExtensionId = "bnmeokbnbegjnbddihbidleappfkiimj";
            let port = chrome.runtime.connect(laserExtensionId);

            async function sendSessionToDVO() {
                const session = await solid.auth.currentSession();
                if (session && session.webId) {
                    port.postMessage({
                        type: "storeSolidSessionToken",
                        sessionToken: session,
                        profileUrl: window.location.host
                    });
                }
            }

            async function login(idp) {
                const session = await solid.auth.currentSession();
                if (!session) {
                    await solid.auth.login(idp);
                    
                    sendSessionToDVO()
                } else {
                    alert(`Logged in as ${session.webId}`);
                }

            }

            $('#submit').click(function() {
                let provider = $("#provider").val();
                login(provider);
            });
            $('#send').click(async function() {
                sendSessionToDVO(); // This should happen automatically
                const session = await solid.auth.currentSession();
                let url = window.location.host;
                let query = `/?webId=${session.webId}`;
                let linkToProfile = url + query;
                $('.linkToProfile').show();
                $('.linkToProfile a').attr('href', query).text(linkToProfile);
            });
            /**** This is for testing purposes ****/
            $('#clear').click(function() {
                //solid.auth.logout();
                //localStorage.clear();
                localStorage.removeItem("solid-auth-client");
                port.postMessage({
                    type: "clearLocalStorage"
                });
            });
            /**** reload page with access token *****/
            $('#reload').click(function() {
                window.location = window.location.pathname
            });
        })

    </script>
</head>

<div id="intro">
    <img class="logo" src="images/logo.png">
    <div id="login">
        <div class="form-group linkToProfile" style="display:none">
            <h1>Congratulations! Your site is live!</h1>
            <a target="_blank" href=""></a>
        </div>
        <div class="form-group">
            <h2>Choose a provider</h2>
            <select id="provider" class="form-control">
                <option value="https://inrupt.net">Inrupt</option>
                <option value="https://solid.community/">Solid</option>
            </select>
        </div>
        <p>NOTE: Only the login button will be used in production</p>
        <div class="form-group">
            <button id="submit" class="btn btn-blue">LOGIN</button>
            <button id="send" class="btn btn-red">SEND TOKEN</button>
            <button id="clear" class="btn btn-green">CLEAR</button>
            <button id="reload" class="btn btn-yellow">RELOAD</button>
        </div>
    </div>
    <div class="signup">
        <h2>Don't have a POD (Personal Online Datastore) yet? Get one for free.</h2></div>
    <div class="choose">
        <div>
            <p><img src="images/inrupt.png"></p>
            <p>
                <a target="_blank" href="https://inrupt.net/register" class="btn btn-red">GET A POD</a>
            </p>
        </div>
        <div>
            <p><img src="images/solid.png"></p>
            <p>
                <a target="_blank" href="https://solid.community/register" class="btn btn-red">GET A POD</a>
            </p>
        </div>
    </div>
</div>
