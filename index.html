<!DOCTYPE html>
<title>DVO Profile</title>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon">
    <!--<link rel="stylesheet" href="/css/reset.css">-->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <link rel="stylesheet" href="css/trumbowyg.min.css">
    <script src="js/vendor/solid-auth-client.bundle.js"></script>
    <script src="js/vendor/solid-file-client.bundle.js"></script>
    <script src="js/vendor/rdflib.min.js"></script>
    <script src="js/vendor/jquery.js"></script>
    <style>
        .page {
            display: none;
        }

    </style>
    <script>
        $(document).ready(function() {
            function getHashParams() {
                var hashParams = {};
                var e,
                    a = /\+/g, // Regex for replacing addition symbol with a space
                    r = /([^&;=]+)=?([^&;]*)/g,
                    d = function(s) {
                        return decodeURIComponent(s.replace(a, " "));
                    },
                    q = window.location.hash.substring(1);
                while (e = r.exec(q))
                    hashParams[d(e[1])] = d(e[2]);
                return hashParams;
            }

            let hash = getHashParams();
            console.log(hash);
            if( Object.entries(hash).length > 0){ 
               $('#viewProfile span').text('VIEW PROFILE'); 
                $('#viewProfile').removeClass('btn-blue'); 
                $('#viewProfile').addClass('btn-red');
                $('.sidebar-sub-header').html('You are logged in');
            }

            let laserExtensionId = "bnmeokbnbegjnbddihbidleappfkiimj";
            let port = chrome.runtime.connect(laserExtensionId);

            async function sendSessionToDVO() {
                const session = await solid.auth.currentSession();
                if (session && session.webId) {
                    port.postMessage({
                        type: "storeSolidSessionToken",
                        sessionToken: session,
                        profileUrl: window.location.host
                    });
                }
            }

            async function login(idp) {
                const session = await solid.auth.currentSession();
                if (!session) {
                    await solid.auth.login(idp);

                    sendSessionToDVO()
                } else {
                    alert(`Logged in as ${session.webId}`);
                }

            }

            $('#submit').click(function() {
                let provider = $("#provider").val();
                login(provider);
            });
            $('#send').click(async function() {
                sendSessionToDVO(); // This should happen automatically
                const session = await solid.auth.currentSession();
                let url = `profile.html?webId=${session.webId}`;
                window.open(url, '_blank');
                $('.linkToProfile').show();
                $('.linkToProfile a').attr('href', url).text(url);
            });
            $('#viewProfile').click(async function() {
                const session = await solid.auth.currentSession();
                let url = `profile.html?webId=${session.webId}`;
                window.open(url, '_blank');
            });
            /**** This is for testing purposes ****/
            $('#clear').click(function() {
                //solid.auth.logout();
                //localStorage.clear();
                localStorage.removeItem("solid-auth-client");
                port.postMessage({
                    type: "clearLocalStorage"
                });
            });
            /**** reload page with access token *****/
            $('#reload').click(function() {
                window.location = window.location.pathname
            });
        })

    </script>
</head>
<!--
<div class="header">
    <a target="_blank" href="https://solid.inrupt.com/get-a-solid-pod">LOGIN</a> | <a target="_blank" href="https://solid.inrupt.com/get-a-solid-pod">GET YOUR FREE POD &amp; WEBID</a> | <a target="_blank" href="http://localhost:8000/?webId=https://devolution.inrupt.net/profile/card#me">VIEW YOUR PAGE</a>
</div>-->
<div id="home" class="container">
    <div class="body">
        <div class="sidebar">
            <div class="sidebar-header">
                <a href="/index.html"><img class="logo" src="images/logo.png" /></a>
            </div>
            <div class="sidebar-sub-header">Login</div>
            <div>
                <div class="home-page-login">
                    <div>
                        <select id="provider" class="form-control">
                            <option value="https://inrupt.net">Inrupt</option>
                            <option value="https://solid.community/">Solid</option>
                        </select>
                    </div>
                    <div>
                        <button id="submit" class="btn btn-green"><i class="fa fa-sign-in"></i></button>
                    </div>

                </div>
            </div>
            <div class="sidebar-header">
                <button id="viewProfile" class="btn btn-blue"><i class="fa fa-user"></i><span style="margin-left:10px;">NOT LOGGED IN</span></button>
            </div>
            <div class="sidebar-sub-header">These buttons are for testing</div>
            <div style="text-align: center">
                <button id="send" class="btn btn-red">SEND TOKEN</button>
                <button id="clear" class="btn btn-blue">CLEAR</button>
                <button id="reload" class="btn btn-yellow">RELOAD</button>
            </div>
            <div class="sidebar-sub-header">Documentation</div>
            <div class="sidebar-menu">
                <ul id="details">
                    <li><a class="active page-link" data-page="gettingStarted" href="">Getting Started</a></li>
                    <li><a class="page-link" data-page="about" href="">About</a></li>
                    <li><a class="page-link" data-page="videos" href="">Videos</a></li>
                    <li><a class="page-link" data-page="developers" href="">Developers</a></li>
                    <!--<li><a class="page-link" data-page="tutorials" href="">Tutorials</a></li>
                    <li><a class="page-link" data-page="faq" href="">FAQ</a></li>
                    <li><a class="page-link" data-page="other" href="">Other projects</a></li>-->
                </ul>
            </div>
        </div>
        <div class="home-page-content">
        </div>
        <div class="sidebar">
            <div class="sidebar-header"><img class="profile-photo" src="https://devolution.inrupt.net/profile/profilepic.jpg"></div>
            <div class="sidebar-sub-header">Hi. My name is Glen!</div>
            <div>
                <div class="about-me">
                    <p>I don't charge money for my services. However, If you find any of the services which I offer either userful or interesting, I would greatly appreciate a donation, to help me continue development.</p>
                </div>
            </div>
            <div>
                <button style="display: block; margin: auto;" class="btn btn-red">DONATE</button>
            </div>
            <div class="sidebar-sub-header">Donations received this month</div>
            <div>
                <div class="donations-received">
                    <div>
                        <button class="currency btn btn-yellow">$</button>
                    </div>
                    <div>
                        <input class="amount form-control" placeholder="0">
                    </div>
                </div>
            </div>
            <div class="sidebar-sub-header">NOTE: This will not be updated in real-time</div>
        </div>
    </div>
    <!-- <div class="footer">If you found this service useful, please consider making a <a href="">donation</a></div> -->
</div>
<script src="js/menu.js"></script>
